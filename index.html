<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eye Tracking</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #fff;
            overflow: hidden;
            cursor: none;
            font-family: system-ui, -apple-system, sans-serif;
        }

        #dot {
            position: fixed;
            width: 18px;
            height: 18px;
            background: #000;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 99999;
            transition: opacity 0.3s;
        }

        #calibration {
            position: fixed;
            inset: 0;
            background: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100000;
        }

        #calibration.hidden {
            display: none;
        }

        h1 {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #000;
        }

        p {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
            text-align: center;
            max-width: 500px;
            line-height: 1.6;
        }

        button {
            background: #000;
            color: #fff;
            border: none;
            padding: 18px 48px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 100px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        button:active {
            transform: scale(0.98);
        }

        #instruction {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: #fff;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            z-index: 10001;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        #instruction.show {
            opacity: 1;
        }

        .cal-point {
            position: fixed;
            width: 20px;
            height: 20px;
            background: #000;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 10000;
            animation: pulse 1s ease-in-out infinite;
            transition: all 0.3s;
        }

        .cal-point:hover {
            transform: translate(-50%, -50%) scale(1.3);
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(0,0,0,0.7);
            }
            50% {
                box-shadow: 0 0 0 15px rgba(0,0,0,0);
            }
        }

        #webgazerVideoContainer {
            display: none !important;
        }

        #webgazerFaceOverlay, #webgazerFaceFeedbackBox {
            display: none !important;
        }

        #webgazerGazeDot {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="dot"></div>
    <div id="instruction">–ö–ª–∏–∫–Ω–∏ –Ω–∞ —Ç–æ—á–∫—É, –≥–ª—è–¥—è –Ω–∞ –Ω–µ–µ</div>

    <div id="calibration">
        <h1>üëÅÔ∏è</h1>
        <p>–î–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ç—Ä–µ–∫–∏–Ω–≥–∞ –Ω—É–∂–Ω–∞ –±—ã—Å—Ç—Ä–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞.<br>–ü—Ä–æ—Å—Ç–æ –∫–ª–∏–∫–∞–π –Ω–∞ —Ç–æ—á–∫–∏, –≥–ª—è–¥—è –Ω–∞ –Ω–∏—Ö.</p>
        <button onclick="startTracking()">–ù–∞—á–∞—Ç—å</button>
    </div>

    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <script>
        let dot;
        let instruction;
        let calibrationDiv;
        let isCalibrating = false;
        let calibrationPoints = [];
        let currentPoint = 0;
        let clicksPerPoint = 0;
        const requiredClicksPerPoint = 3;

        // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
        let smoothX = window.innerWidth / 2;
        let smoothY = window.innerHeight / 2;
        const smoothFactor = 0.15;

        window.startTracking = async function() {
            dot = document.getElementById('dot');
            instruction = document.getElementById('instruction');
            calibrationDiv = document.getElementById('calibration');

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ WebGazer
            webgazer.params.showVideo = false;
            webgazer.params.showFaceOverlay = false;
            webgazer.params.showFaceFeedbackBox = false;
            webgazer.params.showGazeDot = false;

            webgazer.setRegression('ridge')
                .setTracker('TFFacemesh')
                .begin();

            webgazer.showPredictionPoints(false);

            // –°–∫—Ä—ã—Ç—å –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã WebGazer
            setTimeout(() => {
                const video = document.getElementById('webgazerVideoContainer');
                if (video) video.style.display = 'none';
            }, 100);

            // –ó–∞–ø—É—Å–∫ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
            startCalibration();
        };

        function startCalibration() {
            calibrationDiv.classList.add('hidden');
            instruction.classList.add('show');
            isCalibrating = true;

            const w = window.innerWidth;
            const h = window.innerHeight;
            const m = 80; // –æ—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞–µ–≤

            // 9 —Ç–æ—á–µ–∫ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
            calibrationPoints = [
                {x: w/2, y: h/2},      // —Ü–µ–Ω—Ç—Ä
                {x: m, y: m},          // –≤–µ—Ä—Ö–Ω–∏–π –ª–µ–≤—ã–π
                {x: w-m, y: m},        // –≤–µ—Ä—Ö–Ω–∏–π –ø—Ä–∞–≤—ã–π
                {x: w-m, y: h-m},      // –Ω–∏–∂–Ω–∏–π –ø—Ä–∞–≤—ã–π
                {x: m, y: h-m},        // –Ω–∏–∂–Ω–∏–π –ª–µ–≤—ã–π
                {x: w/2, y: m},        // –≤–µ—Ä—Ö–Ω–∏–π —Ü–µ–Ω—Ç—Ä
                {x: w-m, y: h/2},      // –ø—Ä–∞–≤—ã–π —Ü–µ–Ω—Ç—Ä
                {x: w/2, y: h-m},      // –Ω–∏–∂–Ω–∏–π —Ü–µ–Ω—Ç—Ä
                {x: m, y: h/2}         // –ª–µ–≤—ã–π —Ü–µ–Ω—Ç—Ä
            ];

            showCalibrationPoint();
        }

        function showCalibrationPoint() {
            if (currentPoint >= calibrationPoints.length) {
                finishCalibration();
                return;
            }

            const point = calibrationPoints[currentPoint];
            const calPoint = document.createElement('div');
            calPoint.className = 'cal-point';
            calPoint.style.left = point.x + 'px';
            calPoint.style.top = point.y + 'px';
            
            calPoint.onclick = function(e) {
                clicksPerPoint++;
                
                // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–∫–∞ –≤ WebGazer
                webgazer.recordScreenPosition(point.x, point.y, 'click');
                
                if (clicksPerPoint >= requiredClicksPerPoint) {
                    calPoint.remove();
                    clicksPerPoint = 0;
                    currentPoint++;
                    
                    if (currentPoint < calibrationPoints.length) {
                        setTimeout(showCalibrationPoint, 300);
                    } else {
                        finishCalibration();
                    }
                }
            };

            document.body.appendChild(calPoint);
        }

        function finishCalibration() {
            isCalibrating = false;
            instruction.classList.remove('show');
            
            // –ó–∞–ø—É—Å–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
            webgazer.setGazeListener(function(data, timestamp) {
                if (data == null) return;

                // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                smoothX += (data.x - smoothX) * smoothFactor;
                smoothY += (data.y - smoothY) * smoothFactor;

                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —ç–∫—Ä–∞–Ω–∞
                smoothX = Math.max(0, Math.min(window.innerWidth, smoothX));
                smoothY = Math.max(0, Math.min(window.innerHeight, smoothY));

                dot.style.left = smoothX + 'px';
                dot.style.top = smoothY + 'px';
            });
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', () => {
            if (webgazer) {
                webgazer.end();
            }
        });

        // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –æ–±—É—á–µ–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–∞—Ö
        document.addEventListener('click', (e) => {
            if (!isCalibrating && webgazer) {
                webgazer.recordScreenPosition(e.clientX, e.clientY, 'click');
            }
        });
    </script>
</body>
</html>
