<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Tracking Studio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        #mainCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            cursor: none;
        }

        #preview {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 320px;
            height: 240px;
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }

        #previewCanvas {
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }

        #video {
            display: none;
        }

        #controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(0,0,0,0.7);
            padding: 20px 30px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
        }

        .color-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .color-btn:hover {
            transform: scale(1.2);
            border-color: #fff;
        }

        .color-btn.active {
            border-color: #fff;
            box-shadow: 0 0 20px currentColor;
        }

        .tool-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: #fff;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tool-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        #gestureInfo {
            position: fixed;
            top: 30px;
            left: 30px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 20px 30px;
            border-radius: 20px;
            font-size: 16px;
            backdrop-filter: blur(10px);
        }

        #gestureInfo h3 {
            margin-bottom: 10px;
            font-size: 20px;
        }

        .gesture-line {
            margin: 5px 0;
            opacity: 0.9;
        }

        #mode {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 700;
            backdrop-filter: blur(10px);
        }

        #loading {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #fff;
            z-index: 10000;
        }

        #loading.hidden {
            display: none;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #gameArea {
            position: fixed;
            inset: 0;
            display: none;
        }

        #gameArea.active {
            display: block;
        }

        .ball {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        #score {
            position: fixed;
            top: 30px;
            right: 370px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 15px 25px;
            border-radius: 20px;
            font-size: 24px;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <canvas id="mainCanvas"></canvas>
    
    <div id="preview">
        <canvas id="previewCanvas"></canvas>
    </div>
    
    <video id="video" autoplay playsinline></video>

    <div id="gestureInfo">
        <h3>‚úã –ñ–µ—Å—Ç—ã</h3>
        <div class="gesture-line">‚òùÔ∏è Pointing Up - –†–∏—Å–æ–≤–∞—Ç—å</div>
        <div class="gesture-line">‚úåÔ∏è Victory - –°–º–µ–Ω–∞ —Ü–≤–µ—Ç–∞</div>
        <div class="gesture-line">üëç Thumb Up - –û—á–∏—Å—Ç–∏—Ç—å</div>
        <div class="gesture-line">‚úä Fist - –°—Ç–µ—Ä–µ—Ç—å</div>
        <div class="gesture-line">üñêÔ∏è Open Palm - –ò–≥—Ä–∞</div>
    </div>

    <div id="mode">üé® –†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è</div>
    <div id="score" style="display: none;">–°—á–µ—Ç: 0</div>

    <div id="controls">
        <div class="color-btn active" style="background: #ff0000" data-color="#ff0000"></div>
        <div class="color-btn" style="background: #00ff00" data-color="#00ff00"></div>
        <div class="color-btn" style="background: #0000ff" data-color="#0000ff"></div>
        <div class="color-btn" style="background: #ffff00" data-color="#ffff00"></div>
        <div class="color-btn" style="background: #ff00ff" data-color="#ff00ff"></div>
        <div class="color-btn" style="background: #00ffff" data-color="#00ffff"></div>
        <div class="color-btn" style="background: #ffffff" data-color="#ffffff"></div>
        <button class="tool-btn" onclick="clearCanvas()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button class="tool-btn" onclick="toggleMode()">–†–µ–∂–∏–º –∏–≥—Ä—ã</button>
    </div>

    <div id="gameArea"></div>

    <div id="loading">
        <div class="spinner"></div>
        <h2>–ó–∞–≥—Ä—É–∑–∫–∞ MediaPipe...</h2>
    </div>

    <script type="module">
        import { GestureRecognizer, FilesetResolver, DrawingUtils } from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14';

        let gestureRecognizer;
        let video, mainCanvas, mainCtx, previewCanvas, previewCtx;
        let drawingUtils;
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let currentColor = '#ff0000';
        let brushSize = 10;
        let isGameMode = false;
        let gameScore = 0;
        let balls = [];
        let lastGesture = '';
        let gestureTimer = 0;

        async function init() {
            video = document.getElementById('video');
            mainCanvas = document.getElementById('mainCanvas');
            mainCtx = mainCanvas.getContext('2d');
            previewCanvas = document.getElementById('previewCanvas');
            previewCtx = previewCanvas.getContext('2d');

            mainCanvas.width = window.innerWidth;
            mainCanvas.height = window.innerHeight;
            previewCanvas.width = 640;
            previewCanvas.height = 480;

            // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { width: 1280, height: 720, facingMode: 'user' }
            });
            video.srcObject = stream;
            await video.play();

            // –ó–∞–≥—Ä—É–∑–∫–∞ MediaPipe
            const vision = await FilesetResolver.forVisionTasks(
                'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm'
            );

            gestureRecognizer = await GestureRecognizer.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/gesture_recognizer/gesture_recognizer/float16/1/gesture_recognizer.task',
                    delegate: 'GPU'
                },
                runningMode: 'VIDEO',
                numHands: 2,
                minHandDetectionConfidence: 0.5,
                minHandPresenceConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            drawingUtils = new DrawingUtils(previewCtx);

            document.getElementById('loading').classList.add('hidden');
            detectHands();
        }

        function detectHands() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const results = gestureRecognizer.recognizeForVideo(video, performance.now());

                // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–≤—å—é
                previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
                previewCtx.drawImage(video, 0, 0, previewCanvas.width, previewCanvas.height);

                if (results.landmarks && results.landmarks.length > 0) {
                    for (let i = 0; i < results.landmarks.length; i++) {
                        const landmarks = results.landmarks[i];
                        
                        // –†–∏—Å—É–µ–º —Å–∫–µ–ª–µ—Ç —Ä—É–∫–∏ –≤ –ø—Ä–µ–≤—å—é
                        drawingUtils.drawConnectors(landmarks, GestureRecognizer.HAND_CONNECTIONS, {
                            color: '#00FF00',
                            lineWidth: 3
                        });
                        drawingUtils.drawLandmarks(landmarks, {
                            color: '#FF0000',
                            lineWidth: 2,
                            radius: 5
                        });

                        // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —É–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–∞–ª—å—Ü–∞ (landmark 8)
                        const indexTip = landmarks[8];
                        const thumbTip = landmarks[4];
                        
                        const x = (1 - indexTip.x) * mainCanvas.width;
                        const y = indexTip.y * mainCanvas.height;

                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∂–µ—Å—Ç–æ–≤
                        if (results.gestures && results.gestures[i]) {
                            const gesture = results.gestures[i][0];
                            handleGesture(gesture.categoryName, x, y, landmarks);
                        }

                        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞
                        if (!isGameMode) {
                            mainCtx.fillStyle = currentColor;
                            mainCtx.beginPath();
                            mainCtx.arc(x, y, 15, 0, Math.PI * 2);
                            mainCtx.fill();
                        }
                    }
                }

                if (isGameMode) {
                    updateGame(results);
                }
            }

            requestAnimationFrame(detectHands);
        }

        function handleGesture(gesture, x, y, landmarks) {
            const now = Date.now();
            
            // –î–µ–±–∞—É–Ω—Å –¥–ª—è –∂–µ—Å—Ç–æ–≤ (–∏–∑–±–µ–≥–∞–µ–º —Å–ø–∞–º–∞)
            if (gesture !== lastGesture) {
                lastGesture = gesture;
                gestureTimer = now;
            }

            if (now - gestureTimer < 300) return;

            switch(gesture) {
                case 'Pointing_Up':
                    // –†–∏—Å–æ–≤–∞–Ω–∏–µ
                    if (!isGameMode) {
                        if (isDrawing) {
                            mainCtx.strokeStyle = currentColor;
                            mainCtx.lineWidth = brushSize;
                            mainCtx.lineCap = 'round';
                            mainCtx.lineJoin = 'round';
                            mainCtx.beginPath();
                            mainCtx.moveTo(lastX, lastY);
                            mainCtx.lineTo(x, y);
                            mainCtx.stroke();
                        }
                        lastX = x;
                        lastY = y;
                        isDrawing = true;
                    }
                    break;

                case 'Victory':
                    // –°–º–µ–Ω–∞ —Ü–≤–µ—Ç–∞
                    if (now - gestureTimer > 1000) {
                        const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffffff'];
                        const currentIndex = colors.indexOf(currentColor);
                        currentColor = colors[(currentIndex + 1) % colors.length];
                        updateActiveColor();
                        gestureTimer = now;
                    }
                    break;

                case 'Thumb_Up':
                    // –û—á–∏—Å—Ç–∫–∞ —Ö–æ–ª—Å—Ç–∞
                    if (now - gestureTimer > 1500) {
                        clearCanvas();
                        gestureTimer = now;
                    }
                    break;

                case 'Closed_Fist':
                    // –°—Ç–∏—Ä–∞–Ω–∏–µ
                    if (!isGameMode) {
                        mainCtx.globalCompositeOperation = 'destination-out';
                        mainCtx.beginPath();
                        mainCtx.arc(x, y, 30, 0, Math.PI * 2);
                        mainCtx.fill();
                        mainCtx.globalCompositeOperation = 'source-over';
                    }
                    isDrawing = false;
                    break;

                case 'Open_Palm':
                    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã
                    if (now - gestureTimer > 2000) {
                        toggleMode();
                        gestureTimer = now;
                    }
                    break;

                default:
                    isDrawing = false;
            }
        }

        function updateGame(results) {
            // –ü—Ä–æ—Å—Ç–∞—è –∏–≥—Ä–∞ - –ª–æ–≤–∏–º —à–∞—Ä–∏–∫–∏ —Ä—É–∫–æ–π
            const gameArea = document.getElementById('gameArea');
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ —à–∞—Ä–∏–∫–∏
            if (Math.random() < 0.02) {
                const ball = document.createElement('div');
                ball.className = 'ball';
                ball.style.left = Math.random() * (window.innerWidth - 40) + 'px';
                ball.style.top = '-40px';
                ball.dataset.speed = (Math.random() * 3 + 2).toString();
                gameArea.appendChild(ball);
                balls.push(ball);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ —à–∞—Ä–∏–∫–æ–≤
            balls = balls.filter(ball => {
                let top = parseFloat(ball.style.top) || 0;
                top += parseFloat(ball.dataset.speed);
                ball.style.top = top + 'px';

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å —Ä—É–∫–æ–π
                if (results.landmarks && results.landmarks.length > 0) {
                    const hand = results.landmarks[0];
                    const palm = hand[9]; // –¶–µ–Ω—Ç—Ä –ª–∞–¥–æ–Ω–∏
                    const handX = (1 - palm.x) * window.innerWidth;
                    const handY = palm.y * window.innerHeight;
                    
                    const ballX = parseFloat(ball.style.left) + 20;
                    const ballY = top + 20;
                    
                    const dist = Math.hypot(handX - ballX, handY - ballY);
                    
                    if (dist < 80) {
                        ball.remove();
                        gameScore++;
                        document.getElementById('score').textContent = '–°—á–µ—Ç: ' + gameScore;
                        return false;
                    }
                }

                // –£–¥–∞–ª—è–µ–º –µ—Å–ª–∏ –≤—ã—à–µ–ª –∑–∞ —ç–∫—Ä–∞–Ω
                if (top > window.innerHeight) {
                    ball.remove();
                    return false;
                }

                return true;
            });
        }

        window.clearCanvas = function() {
            mainCtx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);
        };

        window.toggleMode = function() {
            isGameMode = !isGameMode;
            const modeDiv = document.getElementById('mode');
            const scoreDiv = document.getElementById('score');
            const gameArea = document.getElementById('gameArea');
            const controls = document.getElementById('controls');

            if (isGameMode) {
                modeDiv.textContent = 'üéÆ –†–µ–∂–∏–º –∏–≥—Ä—ã';
                scoreDiv.style.display = 'block';
                gameArea.classList.add('active');
                controls.style.display = 'none';
                clearCanvas();
                gameScore = 0;
                scoreDiv.textContent = '–°—á–µ—Ç: 0';
            } else {
                modeDiv.textContent = 'üé® –†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è';
                scoreDiv.style.display = 'none';
                gameArea.classList.remove('active');
                controls.style.display = 'flex';
                gameArea.innerHTML = '';
                balls = [];
            }
        };

        function updateActiveColor() {
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.color === currentColor);
            });
        }

        // –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –∫–ª–∏–∫–æ–º
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentColor = btn.dataset.color;
                updateActiveColor();
            });
        });

        // –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ–∫–Ω–∞
        window.addEventListener('resize', () => {
            mainCanvas.width = window.innerWidth;
            mainCanvas.height = window.innerHeight;
        });

        init();
    </script>
</body>
</html>
